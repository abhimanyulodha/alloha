<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alloha - Cacti Facti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: linear-gradient(135deg, #FDFCFB 0%, #E2D1C3 100%);
            --card: rgba(255, 255, 255, 0.85);
            --text: #5D4037;
            --text-secondary: #8D6E63;
            --accent: #E57373;
            --accent-light: rgba(229, 115, 115, 0.1);
            --accent-gradient: linear-gradient(135deg, #E57373 0%, #FF8A65 100%);
            --accent-gradient-shaded: linear-gradient(135deg, #EE9A9A 0%, #FFCCBC 100%);
            --highlighted-bg: rgba(229, 115, 115, 0.15);
            --highlighted-border: rgba(229, 115, 115, 0.3);
            --grid-cell-bg: #FAF8F5;
            --toggle-bg-inactive: #E0E0E0;
            --stuck-block: linear-gradient(135deg, #757575 0%, #616161 100%);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-soft: 0 6px 20px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 12px 40px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.10);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-quick: cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease-in-out;
        }
        .themed-button {
            font-weight: 600; border-radius: 12px; transition: all 0.3s var(--ease-smooth);
            border: none; position: relative; overflow: hidden; transform-origin: center;
        }
        .themed-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .themed-button:active { transform: scale(0.98); transition-duration: 0.1s; }
        
        .glass-card {
            background: var(--card);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: var(--shadow-soft), 0 0 0 1px var(--glass-border), inset 0 1px 0 rgba(255, 255, 255, 0.3); border: none !important; transition: all 0.3s var(--ease-smooth); position: relative; overflow: hidden;
        }
        .grid-cell {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: clamp(1.2rem, 5.5vw, 2.75rem);
            transition: all 0.3s var(--ease-smooth); background: var(--grid-cell-bg);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; min-width: 40px; min-height: 40px;
        }
        .themed-modal { border-radius: 20px; background: var(--card); box-shadow: var(--shadow-strong); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        
        #new-game-btn, #confirm-restart-btn, #play-again-btn { background: var(--accent-gradient); }
        #select-edition-btn { background: var(--accent-gradient-shaded); }

        .progress-bar-container { position: relative; overflow: hidden; background: var(--accent-light); border-radius: 9999px; }
        .progress-bar-fill { background: var(--accent-gradient); position: relative; overflow: hidden; transition: width 0.3s var(--ease-smooth); height: 100%; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%); animation: progress-shimmer 2s infinite; }
        @keyframes progress-shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        @keyframes dice-tumble {
            0%   { transform: rotate(0deg) scale(1); filter: blur(0px); }
            25%  { transform: rotate(-90deg) scale(1.05); }
            50%  { transform: rotate(-180deg) scale(1.1); filter: blur(3px); }
            75%  { transform: rotate(-270deg) scale(1.05); }
            100% { transform: rotate(-360deg) scale(1); filter: blur(0px); }
        }
        .dice-tumble {
            animation: dice-tumble 0.6s var(--ease-bounce);
        }
        .shake-animation { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-3deg); } 75% { transform: translateX(5px) rotate(3deg); } }

        .modal { transition: all 0.3s var(--ease-smooth); }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { transition: all 0.3s var(--ease-smooth); }
        .modal.is-open .modal-content { transform: scale(1) translateY(0); }
        
        .superpower-btn { background: transparent; border: none; box-shadow: none; color: var(--text-secondary); font-weight: 500; border-radius: 12px; padding: 4px; font-size: 0.7rem; text-align: center; transition: all 0.3s ease; cursor: pointer; min-width: 50px; line-height: 1.2; }
        .superpower-btn:hover:not(:disabled) { transform: translateY(-2px); text-decoration: underline; background: var(--accent-light); }
        .superpower-btn--active { font-weight: 700; transform: translateY(-2px) !important; background: var(--accent-light); }
        .superpower-btn:disabled { opacity: 0.5; cursor: not-allowed; text-decoration: none; }
        
        #close-rules-btn, #close-game-over-btn, #close-edition-select-btn, #confirm-cancel-btn { color: var(--text-secondary); }
        #close-rules-btn:hover, #close-game-over-btn:hover, #close-edition-select-btn:hover, #confirm-cancel-btn:hover { color: var(--text); background-color: var(--accent-light); }
        
        .score-display-cell { 
            background: var(--grid-cell-bg) !important; 
            color: var(--text-secondary);
            font-size: clamp(1rem, 4vw, 1.5rem);
        }
        .highlighted { 
            background-color: var(--highlighted-bg); 
            border: 1px solid var(--highlighted-border);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.2); 
            animation: pulse-highlight 2s infinite; 
        }
        @keyframes pulse-highlight { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); } 70% { box-shadow: 0 0 0 4px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
        
        .alloha-logo { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .alloha-logo svg { width: 100%; height: 100%; }
        .alloha-logo svg path, .alloha-logo svg g { fill: var(--accent) !important; }

        #mode-toggle-switch { transition: background-color 0.2s ease-in-out; background-color: var(--toggle-bg-inactive); }
        #mode-toggle-switch.time-burst-active { background-color: var(--accent); }
        #mode-toggle-switch.time-burst-active #mode-toggle-thumb { transform: translateX(1.5rem); }

        #timer-display { 
            font-variant-numeric: tabular-nums;
            transform: translateZ(0); /* Flicker fix */
        }

        #edition-options::-webkit-scrollbar { width: 8px; }
        #edition-options::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        #edition-options::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #edition-options::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        .edition-selected { background-color: var(--accent-light) !important; font-weight: 700; color: var(--accent); }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 16px;
            background: var(--accent);
            top: -20px;
            opacity: 0;
            animation-timing-function: linear;
        }
        @keyframes confetti-fall {
            0% { top: -20px; opacity: 1; transform: rotate(0deg); }
            100% { top: 100%; opacity: 1; transform: rotate(720deg); }
        }
        .focused-cell {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
            box-shadow: 0 0 12px var(--accent);
        }
    </style>
</head>
<body class="p-2 lg:p-4">
    <audio id="audio-unlocker" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" preload="auto"></audio>
    <main id="game-container" class="w-full max-w-5xl mx-auto flex flex-col lg:flex-row gap-4 lg:gap-6 items-center lg:items-stretch pt-8 lg:pt-16">
        <div class="w-full lg:w-2/3 relative">
            <div id="effects-container" class="absolute inset-0 pointer-events-none z-10 overflow-hidden"></div>
            <div id="game-board-container" class="p-2 lg:p-6 rounded-card shadow-lg h-full">
                <div class="grid grid-cols-8 gap-1 lg:gap-3 h-full">
                    <div id="game-board" class="col-span-7 grid grid-cols-7 gap-1 lg:gap-2"></div>
                    <div id="row-scores-display" class="col-span-1 grid grid-rows-7 gap-1 lg:gap-2"></div>
                    <div id="col-scores-display" class="col-span-7 grid grid-cols-7 mt-1 lg:mt-0 gap-1 lg:gap-2"></div>
                    <div class="flex items-center justify-center p-1">
                        <div class="alloha-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 396.75 396.749985" preserveAspectRatio="xMidYMid meet"><defs><clipPath id="864cd2432c"><path d="M 40 0 L 355 0 L 355 396.5 L 40 396.5 Z M 40 0 "/></clipPath></defs><g clip-path="url(#864cd2432c)"><g transform="matrix(1, 0, 0, 1, 40, 0)"><g><g transform="matrix(1, 0, 0, 1, 1, 0)"><g><g fill-opacity="1"><g transform="translate(0.873977, 194.870819)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 6.804688 -174.546875 L 6.804688 0 L 50.503906 0 L 50.503906 -48.675781 L 94.207031 -48.675781 L 94.207031 0 Z M 94.207031 -88.449219 L 50.503906 -88.449219 L 50.503906 -134.507812 L 94.207031 -134.507812 Z M 94.207031 -88.449219 "/></g></g></g></g><g transform="matrix(1, 0, 0, 1, 146, 116)"><g><g fill-opacity="1"><g transform="translate(1.206642, 267.950498)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 6.804688 -174.546875 L 6.804688 0 Z M 94.207031 -39.777344 L 50.503906 -39.777344 L 50.503906 -134.507812 L 94.207031 -134.507812 Z M 94.207031 -39.777344 "/></g></g></g></g></g><g transform="matrix(1, 0, 0, 1, 148, 0)"><g><g fill-opacity="1"><g transform="translate(0.26582, 194.870819)"><g><path d="M 137.386719 0 L 137.386719 -39.777344 L 50.503906 -39.777344 L 50.503906 -174.546875 L 6.804688 -174.546875 L 6.804688 0 Z M 137.386719 0 "/></g></g></g></g></g><g transform="matrix(1, 0, 0, 1, -0.000000000000007105, 116)"><g><g fill-opacity="1"><g transform="translate(1.876102, 267.950498)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 94.207031 -174.546875 L 94.207031 -107.03125 L 50.503906 -107.03125 L 50.503906 -174.546875 L 6.804688 -174.546875 L 6.804688 0 L 50.503906 0 L 50.503906 -68.5625 L 94.207031 -68.5625 L 94.207031 0 Z M 137.910156 0 "/></g></g></g></g></g><g transform="matrix(1, 0, 0, 1, 242, 20)"><g><path fill-rule="nonzero" d="M 43.164062 120.25 L 0.375 120.25 L 0.375 0.414062 L 43.164062 0.414062 Z M 43.164062 120.25 "/></g></g><g transform="matrix(1, 0, 0, 1, 213, 20)"><g><path fill-rule="nonzero" d="M 0.839844 43.222656 L 0.839844 0.4375 L 63.683594 0.4375 L 63.683594 43.222656 Z M 0.839844 43.222656 "/></g></g></g></g></g></g></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="w-full lg:w-1/3">
            <div id="scoring-panel" class="relative flex-1 flex flex-col gap-y-4 p-4 lg:p-6 glass-card rounded-2xl">
                
                <div id="pre-game-content"></div>
                <div id="in-game-content"></div>

                <div class="relative w-full h-2.5 progress-bar-container mt-2">
                    <div id="progress-bar-fill" class="progress-bar-fill h-full rounded-full" style="width: 0%;"></div>
                </div>

                <div class="flex justify-center items-center gap-3">
                    <button id="rules-btn" class="flex-1 py-2 px-4 themed-button text-sm" style="color: var(--accent); background: var(--accent-light);">How to Play</button>
                    <button id="new-game-btn" class="flex-1 py-2 px-4 themed-button text-white text-sm">New Game</button>
                </div>

                <div class="text-center">
                    <button id="select-edition-btn" class="w-full py-2 px-4 themed-button text-white text-sm flex items-center justify-center gap-2">
                        Select Game Edition
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <p id="current-edition-display" class="text-xs font-semibold mt-2" style="color: var(--text-secondary);"></p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="glass-card rounded-xl px-3 py-2">
                        <h3 class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-secondary);">Total Score</h3>
                        <p id="total-score" class="text-2xl font-bold" style="color: var(--accent);">0</p>
                    </div>
                    <div class="glass-card rounded-xl px-3 py-2">
                        <h3 class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-secondary);">High Score</h3>
                        <p id="high-score" class="text-2xl font-bold" style="color: #FFC107;">0</p>
                    </div>
                </div>
                <div id="score-breakdown-card" class="glass-card rounded-xl p-3 text-center">
                    <div class="grid grid-cols-2 gap-2">
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Rows</h3><p id="rows-total-score" class="text-lg font-bold">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Columns</h3><p id="cols-total-score" class="text-lg font-bold">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Twinning</h3><p id="cross-total-score" class="text-lg font-bold" style="color: #FFC107;">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Grid Bonus</h3><p id="bonus-grid-score" class="text-lg font-bold" style="color: #FFC107;">0</p></div>
                    </div>
                    <div class="border-t border-white/20 mt-2 pt-2">
                        <div class="flex justify-center items-center gap-4">
                             <h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Bomb Squad Charge</h3>
                             <p id="empty-block-penalty" class="text-lg font-bold" style="color: var(--text);">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="rules-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-lg themed-modal p-6 transform scale-95 -translate-y-4">
            <div id="rules-content" class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2" style="color: var(--text-secondary)">
                </div>
        </div>
    </div>
    
    <div id="edition-select-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm themed-modal p-6 transform scale-95 -translate-y-4">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold" style="color: var(--accent);">Select Edition</h2>
                 <button id="close-edition-select-btn" class="w-10 h-10 rounded-full text-xl flex items-center justify-center font-bold">Ã—</button>
            </div>
            <div class="flex items-center justify-center mb-4 space-x-4">
                <span id="classic-text" class="font-semibold" style="color: var(--text-secondary)">Classic</span>
                <div id="mode-toggle-switch" class="w-14 h-8 flex items-center rounded-full p-1 cursor-pointer">
                    <div id="mode-toggle-thumb" class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform"></div>
                </div>
                <span id="time-burst-text" class="font-semibold" style="color: var(--text-secondary)">Time Burst</span>
            </div>
            <div id="edition-options" class="flex flex-col gap-3 max-h-64 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="confirm-restart-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm themed-modal p-8 text-center transform scale-95 -translate-y-4">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent);">Restart Game?</h2>
            <p class="mb-6" style="color: var(--text-secondary);">Your current progress will be lost. Are you sure?</p>
            <div class="flex justify-center items-center gap-3">
                <button id="confirm-cancel-btn" class="flex-1 py-2 px-4 themed-button text-sm" style="color: var(--text-secondary); background: rgba(0,0,0,0.05);">Cancel</button>
                <button id="confirm-restart-btn" class="flex-1 py-2 px-4 themed-button text-white text-sm">Restart</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-md text-center themed-modal p-8 transform scale-95 -translate-y-4 relative">
            <button id="close-game-over-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full text-xl flex items-center justify-center font-bold">Ã—</button>
            <h2 class="text-4xl font-bold mb-2" style="color: var(--accent); font-family: 'Pacifico', cursive;">Game Over!</h2>
            <p id="game-over-reason" class="text-lg mt-2 mb-4" style="color: var(--accent);"></p>
            <p id="final-score-modal" class="text-7xl font-bold my-4" style="color: var(--accent);">0</p>
            <div id="score-breakdown" class="mb-6 p-4 glass-card rounded-xl text-xs">
                <div class="grid grid-cols-2 gap-2">
                    <div class="text-left">Rows: <span id="final-rows-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Columns: <span id="final-cols-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Twinning: <span id="final-cross-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Bonus Grids: <span id="final-bonus-score" class="float-right font-bold">0</span></div>
                    <div class="text-left col-span-2 border-t pt-2 mt-2">Bomb Squad Charge: <span id="final-penalty-score" class="float-right font-bold">0</span></div>
                </div>
            </div>
            <p>High score: <span id="high-score-modal" class="font-bold" style="color: #FFC107;">0</span></p>
            <button id="play-again-btn" class="w-full mt-6 themed-button text-white font-bold py-3 px-4 rounded-xl text-xl">Play Again</button>
        </div>
    </div>

    <div id="exchange-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm text-center themed-modal p-6 transform scale-95 -translate-y-4">
            <h2 class="text-xl font-bold mb-4" style="color: var(--accent);">Choose a new Alloha</h2>
            <div id="exchange-options" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script>
        // --- THEME CONFIGURATIONS ---
        const themeConfigs = {
            pastel_pals: {
                name: "Pastel Pals",
                symbols: ['ðŸ°', 'ðŸ¶', 'ðŸ¯', 'ðŸ¼', 'ðŸ¦„', 'ðŸ¸'],
                palette: {
                    bg: 'linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%)',
                    card: 'rgba(255, 255, 255, 0.88)',
                    text: '#4A148C',
                    text_secondary: '#7B1FA2',
                    accent: '#8E24AA',
                    accent_gradient: 'linear-gradient(135deg, #8E24AA 0%, #AB47BC 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #BA68C8 0%, #CE93D8 100%)',
                    highlighted_bg: 'rgba(142, 36, 170, 0.15)',
                    highlighted_border: 'rgba(142, 36, 170, 0.3)',
                    grid_cell_bg: '#F9F6FB',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸ°':'text-pink-400', 'ðŸ¶':'text-amber-600', 'ðŸ¯':'text-orange-500', 'ðŸ¼':'text-gray-700', 'ðŸ¦„':'text-purple-500', 'ðŸ¸':'text-green-500' }
            },
            green_grocer: {
                name: "Green Grocer",
                symbols: ['ðŸ¥‘', 'ðŸ¥¦', 'ðŸ§„', 'ðŸŒ½', 'ðŸ«‘', 'ðŸŒ¶ï¸'],
                palette: {
                    bg: 'linear-gradient(135deg, #F1F8E9 0%, #DCEDC8 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#33691E',
                    text_secondary: '#689F38',
                    accent: '#8BC34A',
                    accent_gradient: 'linear-gradient(135deg, #8BC34A 0%, #9CCC65 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #AED581 0%, #C5E1A5 100%)',
                    highlighted_bg: 'rgba(139, 195, 74, 0.15)',
                    highlighted_border: 'rgba(139, 195, 74, 0.3)',
                    grid_cell_bg: '#FCFFF5',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸ¥‘':'text-green-800', 'ðŸ¥¦':'text-green-600', 'ðŸ§„':'text-gray-500', 'ðŸŒ½':'text-yellow-500', 'ðŸ«‘':'text-green-700', 'ðŸŒ¶ï¸':'text-red-600' }
            },
            bug_life: {
                name: "Bug's Life",
                symbols: ['ðŸ¦‹', 'ðŸ', 'ðŸª²', 'ðŸ›', 'ðŸž', 'ðŸª°'],
                palette: {
                    bg: 'linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%)',
                    card: 'rgba(255, 255, 255, 0.85)',
                    text: '#004D40',
                    text_secondary: '#00796B',
                    accent: '#009688',
                    accent_gradient: 'linear-gradient(135deg, #009688 0%, #26A69A 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #4DB6AC 0%, #80CBC4 100%)',
                    highlighted_bg: 'rgba(0, 150, 136, 0.15)',
                    highlighted_border: 'rgba(0, 150, 136, 0.3)',
                    grid_cell_bg: '#F5FCFB',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸ¦‹':'text-blue-500', 'ðŸ':'text-yellow-500', 'ðŸª²':'text-amber-800', 'ðŸ›':'text-lime-600', 'ðŸž':'text-red-600', 'ðŸª°':'text-gray-700' }
            },
            golden_bakery: {
                name: "Golden Bakery",
                symbols: ['ðŸž', 'ðŸ¥¯', 'ðŸ¥', 'ðŸ§‡', 'ðŸª', 'ðŸ¥ž'],
                palette: {
                    bg: 'linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#8D6E63',
                    text_secondary: '#A1887F',
                    accent: '#AF8260',
                    accent_gradient: 'linear-gradient(135deg, #AF8260 0%, #C19A7B 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #D4B298 0%, #E6C9B4 100%)',
                    highlighted_bg: 'rgba(175, 130, 96, 0.15)',
                    highlighted_border: 'rgba(175, 130, 96, 0.3)',
                    grid_cell_bg: '#FFFBF2',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸž':'text-amber-800', 'ðŸ¥¯':'text-amber-700', 'ðŸ¥':'text-orange-600', 'ðŸ§‡':'text-yellow-700', 'ðŸª':'text-amber-900', 'ðŸ¥ž':'text-amber-600' }
            },
            school_of_magic: {
                name: "School of Magic",
                symbols: ['ðŸ§™â€â™€ï¸', 'ðŸ¦‰', 'ðŸ“œ', 'ðŸ†', 'ðŸŸï¸', 'ðŸ”®'],
                palette: {
                    bg: 'linear-gradient(135deg, #4E342E 0%, #212121 100%)',
                    card: 'rgba(78, 52, 46, 0.75)',
                    text: '#FFECB3',
                    text_secondary: '#D7CCC8',
                    accent: '#D32F2F',
                    accent_gradient: 'linear-gradient(135deg, #D32F2F 0%, #FFC107 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #EF5350 0%, #FFD54F 100%)',
                    highlighted_bg: 'rgba(211, 47, 47, 0.15)',
                    highlighted_border: 'rgba(211, 47, 47, 0.3)',
                    grid_cell_bg: '#5D4037',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸ§™â€â™€ï¸':'text-purple-300', 'ðŸ¦‰':'text-gray-300', 'ðŸ“œ':'text-yellow-200', 'ðŸ†':'text-yellow-400', 'ðŸŸï¸':'text-gray-400', 'ðŸ”®':'text-purple-400' }
            },
            deep_ocean: {
                name: "Deep Ocean",
                symbols: ['ðŸ¡', 'ðŸ¦‘', 'ðŸ¦€', 'ðŸ™', 'ðŸ³', 'ðŸ '],
                palette: {
                    bg: 'linear-gradient(135deg, #1A237E 0%, #0D47A1 100%)',
                    card: 'rgba(26, 35, 126, 0.7)',
                    text: '#E3F2FD',
                    text_secondary: '#90CAF9',
                    accent: '#42A5F5',
                    accent_gradient: 'linear-gradient(135deg, #42A5F5 0%, #64B5F6 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #90CAF9 0%, #BBDEFB 100%)',
                    highlighted_bg: 'rgba(66, 165, 245, 0.2)',
                    highlighted_border: 'rgba(66, 165, 245, 0.4)',
                    grid_cell_bg: '#1976D2',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸ¡':'text-yellow-300', 'ðŸ¦‘':'text-pink-300', 'ðŸ¦€':'text-red-400', 'ðŸ™':'text-purple-300', 'ðŸ³':'text-blue-300', 'ðŸ ':'text-orange-300' }
            },
            concrete_justice: {
                name: "Concrete Justice",
                symbols: ['â›“ï¸', 'ðŸš”', 'ðŸ‘®', 'ðŸ›ï¸', 'ðŸ”’', 'ðŸšª'],
                palette: {
                    bg: 'linear-gradient(135deg, #455A64 0%, #263238 100%)',
                    card: 'rgba(55, 71, 79, 0.8)',
                    text: '#ECEFF1',
                    text_secondary: '#B0BEC5',
                    accent: '#1976D2',
                    accent_gradient: 'linear-gradient(135deg, #1976D2 0%, #2196F3 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #42A5F5 0%, #64B5F6 100%)',
                    highlighted_bg: 'rgba(25, 118, 210, 0.15)',
                    highlighted_border: 'rgba(25, 118, 210, 0.3)',
                    grid_cell_bg: '#546E7A',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'â›“ï¸':'text-gray-300', 'ðŸš”':'text-blue-300', 'ðŸ‘®':'text-yellow-300', 'ðŸ›ï¸':'text-gray-200', 'ðŸ”’':'text-amber-300', 'ðŸšª':'text-orange-300' }
            },
            the_post_office: {
                name: "The Post Office",
                symbols: ['ðŸ“¦', 'ðŸ“®', 'ðŸ—‚ï¸', 'ðŸ—³ï¸', 'ðŸ—„ï¸', 'ðŸ“¬'],
                palette: {
                    bg: 'linear-gradient(135deg, #EFEBE9 0%, #D7CCC8 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#3E2723',
                    text_secondary: '#6D4C41',
                    accent: '#D32F2F',
                    accent_gradient: 'linear-gradient(135deg, #D32F2F 0%, #E53935 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #EF5350 0%, #E57373 100%)',
                    highlighted_bg: 'rgba(211, 47, 47, 0.1)',
                    highlighted_border: 'rgba(211, 47, 47, 0.25)',
                    grid_cell_bg: '#F8F5F3',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸ“¦':'text-amber-800', 'ðŸ“®':'text-red-600', 'ðŸ—‚ï¸':'text-gray-500', 'ðŸ—³ï¸':'text-blue-700', 'ðŸ—„ï¸':'text-gray-600', 'ðŸ“¬':'text-red-700' }
            },
            tutti_frutti: {
                name: "Tutti Frutti",
                symbols: ['ðŸ“', 'ðŸ«', 'ðŸ‰', 'ðŸ¥', 'ðŸ¥­', 'ðŸ‹'],
                palette: {
                    bg: 'linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#4E342E',
                    text_secondary: '#8D6E63',
                    accent: '#EC407A',
                    accent_gradient: 'linear-gradient(135deg, #EC407A 0%, #F06292 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #F48FB1 0%, #F8BBD0 100%)',
                    highlighted_bg: 'rgba(236, 64, 122, 0.1)',
                    highlighted_border: 'rgba(236, 64, 122, 0.25)',
                    grid_cell_bg: '#FFFFFF',
                    toggle_bg_inactive: '#F0F0F0',
                },
                symbolColors: { 'ðŸ“':'text-red-500', 'ðŸ«':'text-blue-600', 'ðŸ‰':'text-green-600', 'ðŸ¥':'text-lime-700', 'ðŸ¥­':'text-orange-500', 'ðŸ‹':'text-yellow-500' }
            },
            zedi_zodi: {
                name: "Zodiac Night",
                symbols: ['â™‹', 'â™’', 'â™Ž', 'â™', 'â™Œ', 'â™‰'],
                palette: {
                    bg: 'linear-gradient(135deg, #0f0c29 0%, #302b63 100%)',
                    card: 'rgba(48, 43, 99, 0.75)',
                    text: '#E0E6F8',
                    text_secondary: '#A9B4D1',
                    accent: '#FFD700',
                    accent_gradient: 'linear-gradient(135deg, #FFD700 0%, #FFA000 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #FFECB3 0%, #FFD54F 100%)',
                    highlighted_bg: 'rgba(255, 215, 0, 0.15)',
                    highlighted_border: 'rgba(255, 215, 0, 0.3)',
                    grid_cell_bg: '#24243e',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'â™‹':'text-gray-300', 'â™’':'text-blue-300', 'â™Ž':'text-pink-300', 'â™':'text-orange-300', 'â™Œ':'text-yellow-300', 'â™‰':'text-green-300' }
            },
            desert_oasis: {
                name: "Desert Oasis",
                symbols: ['ðŸŒµ', 'ðŸª¨', 'â˜€ï¸', 'ðŸ', 'â›º', 'ðŸŒ´'],
                palette: {
                    bg: 'linear-gradient(135deg, #FFECB3 0%, #FFD54F 100%)',
                    card: 'rgba(255, 255, 255, 0.85)',
                    text: '#5D4037',
                    text_secondary: '#8D6E63',
                    accent: '#00897B',
                    accent_gradient: 'linear-gradient(135deg, #00897B 0%, #26A69A 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #4DB6AC 0%, #80CBC4 100%)',
                    highlighted_bg: 'rgba(0, 137, 123, 0.15)',
                    highlighted_border: 'rgba(0, 137, 123, 0.3)',
                    grid_cell_bg: '#FFFBF2',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸŒµ':'text-green-700', 'ðŸª¨':'text-gray-600', 'â˜€ï¸':'text-yellow-600', 'ðŸ':'text-emerald-800', 'â›º':'text-orange-700', 'ðŸŒ´':'text-lime-800' }
            },
            morning_aviary: {
                name: "Morning Aviary",
                symbols: ['ðŸ”', 'ðŸ¦', 'ðŸ¥', 'ðŸ£', 'ðŸ', 'ðŸ§'],
                palette: {
                    bg: 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#0D47A1',
                    text_secondary: '#1976D2',
                    accent: '#FFA000',
                    accent_gradient: 'linear-gradient(135deg, #FFA000 0%, #FFB300 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #FFC107 0%, #FF8F00 100%)',
                    highlighted_bg: 'rgba(255, 160, 0, 0.15)',
                    highlighted_border: 'rgba(255, 160, 0, 0.3)',
                    grid_cell_bg: '#F7FBFF',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸ”':'text-red-600', 'ðŸ¦':'text-blue-500', 'ðŸ¥':'text-yellow-500', 'ðŸ£':'text-yellow-400', 'ðŸ':'text-yellow-600', 'ðŸ§':'text-gray-800' }
            },
            creepy_crawlies: {
                name: "Creepy Crawlies",
                symbols: ['ðŸ', 'ðŸ¦Ž', 'ðŸ¦‚', 'ðŸ­', 'ðŸ¥š', 'ðŸ'],
                palette: {
                    bg: 'linear-gradient(135deg, #37474F 0%, #212121 100%)',
                    card: 'rgba(38, 50, 56, 0.8)',
                    text: '#CFD8DC',
                    text_secondary: '#90A4AE',
                    accent: '#7E57C2',
                    accent_gradient: 'linear-gradient(135deg, #7E57C2 0%, #9575CD 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #B39DDB 0%, #D1C4E9 100%)',
                    highlighted_bg: 'rgba(126, 87, 194, 0.15)',
                    highlighted_border: 'rgba(126, 87, 194, 0.3)',
                    grid_cell_bg: '#455A64',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸ':'text-green-400', 'ðŸ¦Ž':'text-lime-400', 'ðŸ¦‚':'text-red-400', 'ðŸ­':'text-gray-300', 'ðŸ¥š':'text-gray-200', 'ðŸ':'text-gray-100' }
            },
            ancient_secrets: {
                name: "Ancient Secrets",
                symbols: ['ðŸ”', 'ðŸ§©', 'ðŸ€„', 'ðŸ”‘', 'ðŸ§­', 'ðŸ‘ï¸'],
                palette: {
                    bg: 'linear-gradient(135deg, #5D4037 0%, #3E2723 100%)',
                    card: 'rgba(62, 39, 35, 0.75)',
                    text: '#D7CCC8',
                    text_secondary: '#A1887F',
                    accent: '#FFCA28',
                    accent_gradient: 'linear-gradient(135deg, #FFC107 0%, #FF8F00 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #FFA000 0%, #FF6F00 100%)',
                    highlighted_bg: 'rgba(255, 202, 40, 0.15)',
                    highlighted_border: 'rgba(255, 202, 40, 0.3)',
                    grid_cell_bg: '#6D4C41',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸ”':'text-blue-300', 'ðŸ§©':'text-orange-300', 'ðŸ€„':'text-red-300', 'ðŸ”‘':'text-yellow-300', 'ðŸ§­':'text-gray-300', 'ðŸ‘ï¸':'text-cyan-300' }
            },
            cosmic_drift: {
                name: "Cosmic Drift",
                symbols: ['ðŸŒ', 'ðŸš€', 'ðŸª', 'ðŸŒ—', 'ðŸ’«', 'ðŸ›°ï¸'],
                palette: {
                    bg: 'linear-gradient(135deg, #1A237E 0%, #0D123B 100%)',
                    card: 'rgba(48, 59, 128, 0.7)',
                    text: '#E8EAF6',
                    text_secondary: '#9FA8DA',
                    accent: '#536DFE',
                    accent_gradient: 'linear-gradient(135deg, #536DFE 0%, #7C4DFF 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #7C4DFF 0%, #B388FF 100%)',
                    highlighted_bg: 'rgba(83, 109, 254, 0.2)',
                    highlighted_border: 'rgba(83, 109, 254, 0.4)',
                    grid_cell_bg: '#3949AB',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸŒ':'text-blue-300', 'ðŸš€':'text-gray-200', 'ðŸª':'text-amber-300', 'ðŸŒ—':'text-gray-100', 'ðŸ’«':'text-yellow-300', 'ðŸ›°ï¸':'text-blue-200' }
            },
            petal_meadow: {
                name: "Petal Meadow",
                symbols: ['ðŸŒ¸', 'ðŸŒº', 'ðŸŒ·', 'ðŸª·', 'ðŸª»', 'ðŸŒ»'],
                palette: {
                    bg: 'linear-gradient(135deg, #E6EE9C 0%, #C5E1A5 100%)',
                    card: 'rgba(255, 255, 255, 0.9)',
                    text: '#2E7D32',
                    text_secondary: '#558B2F',
                    accent: '#D81B60',
                    accent_gradient: 'linear-gradient(135deg, #D81B60 0%, #E91E63 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #F06292 0%, #F48FB1 100%)',
                    highlighted_bg: 'rgba(216, 27, 96, 0.1)',
                    highlighted_border: 'rgba(216, 27, 96, 0.25)',
                    grid_cell_bg: '#F8FFF0',
                    toggle_bg_inactive: '#E0E0E0',
                },
                symbolColors: { 'ðŸŒ¸':'text-pink-400', 'ðŸŒº':'text-red-500', 'ðŸŒ·':'text-orange-500', 'ðŸª·':'text-pink-500', 'ðŸª»':'text-purple-500', 'ðŸŒ»':'text-yellow-500' }
            },
            monster_mash: {
                name: "Monster Mash",
                symbols: ['ðŸ‘¹', 'ðŸ²', 'ðŸ‘»', 'ðŸ‘½', 'ðŸº', 'ðŸ˜ˆ'],
                palette: {
                    bg: 'linear-gradient(135deg, #4A148C 0%, #1A001A 100%)',
                    card: 'rgba(40, 10, 70, 0.8)',
                    text: '#E1BEE7',
                    text_secondary: '#CE93D8',
                    accent: '#76FF03',
                    accent_gradient: 'linear-gradient(135deg, #52C200 0%, #76FF03 100%)',
                    accent_gradient_shaded: 'linear-gradient(135deg, #64DD17 0%, #AEEA79 100%)',
                    highlighted_bg: 'rgba(118, 255, 3, 0.15)',
                    highlighted_border: 'rgba(118, 255, 3, 0.3)',
                    grid_cell_bg: '#4527A0',
                    toggle_bg_inactive: 'rgba(255,255,255,0.2)',
                },
                symbolColors: { 'ðŸ‘¹':'text-red-400', 'ðŸ²':'text-green-400', 'ðŸ‘»':'text-gray-200', 'ðŸ‘½':'text-lime-300', 'ðŸº':'text-gray-300', 'ðŸ˜ˆ':'text-purple-300' }
            }
        };

        function applyTheme(themeId) {
            const theme = themeConfigs[themeId];
            if (!theme) {
                console.warn(`Theme "${themeId}" not found.`);
                return;
            }
            const root = document.documentElement;
            const palette = theme.palette;
            for (const key in palette) {
                root.style.setProperty(`--${key.replace(/_/g, '-')}`, palette[key]);
            }
        }

        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
        
        // --- VARIANT CONFIGURATIONS ---
        const variantConfigs = {
            'plain_jean': { id: 'plain_jean', name: 'Plain Jean', themeId: 'pastel_pals', timeLimit: 100, isTwinningCell: (r, c) => false, getCrossScoreSegments: () => [] },
            'one_won': { id: 'one_won', name: 'One Won', themeId: 'green_grocer', timeLimit: 100, isTwinningCell: (r, c) => c === 3, getCrossScoreSegments: () => [{ type: 'col', index: 3, start: 0, end: 6 }] },
            'plus_minus': { id: 'plus_minus', name: 'Plus Minus', themeId: 'bug_life', timeLimit: 100, isTwinningCell: (r, c) => r === 3 || c === 3, getCrossScoreSegments: () => [{ type: 'row', index: 3, start: 0, end: 6 }, { type: 'col', index: 3, start: 0, end: 6 }] },
            'sugar_cube': { id: 'sugar_cube', name: 'Sugar Cube', themeId: 'golden_bakery', timeLimit: 100, isTwinningCell: (r, c) => r === 0 || r === 6 || c === 0 || c === 6, getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 0, end: 6 }, { type: 'row', index: 6, start: 0, end: 6 }, { type: 'col', index: 0, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }] },
            'marry_harry': { id: 'marry_harry', name: 'Marry Harry', themeId: 'school_of_magic', timeLimit: 100, isTwinningCell: (r, c) => c === 1 || c === 5 || (r === 3 && c >= 1 && c <= 5), getCrossScoreSegments: () => [ { type: 'col', index: 1, start: 0, end: 6 }, { type: 'col', index: 5, start: 0, end: 6 }, { type: 'row', index: 3, start: 1, end: 5 }] },
            'wonder_wander': { id: 'wonder_wander', name: 'Wonder Wander', themeId: 'deep_ocean', timeLimit: 120, isTwinningCell: (r, c) => r === 6 || [0, 3, 6].includes(c), getCrossScoreSegments: () => [ { type: 'row', index: 6, start: 0, end: 6 }, { type: 'col', index: 0, start: 0, end: 6 }, { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }] },
            'jail_mail': { id: 'jail_mail', name: 'Jail Mail', themeId: 'concrete_justice', timeLimit: 120, isTwinningCell: (r, c) => [0, 2, 4, 6].includes(c), getCrossScoreSegments: () => [ { type: 'col', index: 0, start: 0, end: 6 }, { type: 'col', index: 2, start: 0, end: 6 }, { type: 'col', index: 4, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }] },
            'box_vox': { id: 'box_vox', name: 'Box Vox', themeId: 'the_post_office', timeLimit: 120, isTwinningCell: (r, c) => [0, 3, 6].includes(r) || [0, 3, 6].includes(c), getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 0, end: 6 }, { type: 'row', index: 3, start: 0, end: 6 }, { type: 'row', index: 6, start: 0, end: 6 }, { type: 'col', index: 0, start: 0, end: 6 }, { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }] },
            'hash_hush': { id: 'hash_hush', name: 'Hash Hush', themeId: 'tutti_frutti', timeLimit: 120, isTwinningCell: (r, c) => [2, 4].includes(r) || [2, 4].includes(c), getCrossScoreSegments: () => [ { type: 'row', index: 2, start: 0, end: 6 }, { type: 'row', index: 4, start: 0, end: 6 }, { type: 'col', index: 2, start: 0, end: 6 }, { type: 'col', index: 4, start: 0, end: 6 }] },
            'zedi_zodi': { id: 'zedi_zodi', name: 'Zedi Zodi', themeId: 'zedi_zodi', timeLimit: 120, isTwinningCell: (r, c) => r === 0 || r === 6 || r + c === 6, getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 0, end: 6 }, { type: 'row', index: 6, start: 0, end: 6 }, { type: 'diag_anti' }] },
            'core': { id: 'core', name: 'Cacti Facti Edition', themeId: 'desert_oasis', timeLimit: 150, isTwinningCell: (r, c) => (r === 3 && c >= 3 && c <= 5) || (r === 5 && c >= 1 && c <= 3) || (c === 1 && r >= 1 && r <= 5) || (c === 3) || (c === 5 && r >= 0 && r <= 3), getCrossScoreSegments: () => [ { type: 'row', index: 3, start: 3, end: 5 }, { type: 'row', index: 5, start: 1, end: 3 }, { type: 'col', index: 1, start: 1, end: 5 }, { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 5, start: 0, end: 3 }] },
            'eight_and_watch': { id: 'eight_and_watch', name: 'Eight and Watch', themeId: 'morning_aviary', timeLimit: 150, isTwinningCell: (r, c) => (r === 0 && c >= 3) || (r === 3) || (r === 6 && c <= 3) || (c === 0 && r >= 3) || (c === 3) || (c === 6 && r <= 3), getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 3, end: 6 }, { type: 'row', index: 3, start: 0, end: 6 }, { type: 'row', index: 6, start: 0, end: 3 }, { type: 'col', index: 0, start: 3, end: 6 }, { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 3 }] },
            'fake_snake': { id: 'fake_snake', name: 'Fake Snake', themeId: 'creepy_crawlies', timeLimit: 150, isTwinningCell: (r, c) => (r === 0 && c >= 4) || (r === 2 && c >= 2 && c <= 4) || (r === 4 && c <= 2) || (c === 0 && r >= 4) || (c === 2 && r >= 2 && r <= 4) || (c === 4 && r <= 2), getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 4, end: 6 }, { type: 'row', index: 2, start: 2, end: 4 }, { type: 'row', index: 4, start: 0, end: 2 }, { type: 'col', index: 0, start: 4, end: 6 }, { type: 'col', index: 2, start: 2, end: 4 }, { type: 'col', index: 4, start: 0, end: 2 }] },
            'rune_dune': { id: 'rune_dune', name: 'Rune Dune', themeId: 'ancient_secrets', timeLimit: 150, isTwinningCell: (r, c) => (r === 2 && c >= 1 && c <= 5) || (r === 4 && c >= 1 && c <= 5) || (c === 1 && (r <= 2 || r >= 4)) || (c === 3) || (c === 5 && (r <= 2 || r >= 4)), getCrossScoreSegments: () => [ { type: 'row', index: 2, start: 1, end: 5 }, { type: 'row', index: 4, start: 1, end: 5 }, { type: 'col', index: 1, start: 0, end: 2 }, { type: 'col', index: 1, start: 4, end: 6 }, { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 5, start: 0, end: 2 }, { type: 'col', index: 5, start: 4, end: 6 }] },
            'space_race': { id: 'space_race', name: 'Space Race', themeId: 'cosmic_drift', timeLimit: 180, isTwinningCell: (r, c) => (r === 2 && c >= 2 && c <= 4) || (r === 3 && (c <= 2 || c >= 4)) || (r === 4 && c >= 2 && c <= 4) || (c === 2 && r >= 2 && r <= 4) || (c === 3 && (r <= 2 || r >= 4)) || (c === 4 && r >= 2 && r <= 4), getCrossScoreSegments: () => [ { type: 'row', index: 2, start: 2, end: 4 }, { type: 'row', index: 3, start: 0, end: 2 }, { type: 'row', index: 3, start: 4, end: 6 }, { type: 'row', index: 4, start: 2, end: 4 }, { type: 'col', index: 2, start: 2, end: 4 }, { type: 'col', index: 3, start: 0, end: 2 }, { type: 'col', index: 3, start: 4, end: 6 }, { type: 'col', index: 4, start: 2, end: 4 }] },
            'flower_power': { id: 'flower_power', name: 'Flower Power', themeId: 'petal_meadow', timeLimit: 180, isTwinningCell: (r, c) => (r === 0 && c >= 2 && c <= 4) || (r === 2 && c >= 2 && c <= 4) || r === 4 || (c === 1 && r >= 3 && r <= 5) || (c === 2 && r <= 2) || (c === 3 && r >= 2) || (c === 4 && r <= 2) || (c === 5 && r >= 3 && r <= 5), getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 2, end: 4 }, { type: 'row', index: 2, start: 2, end: 4 }, { type: 'row', index: 4, start: 0, end: 6 }, { type: 'col', index: 1, start: 3, end: 5 }, { type: 'col', index: 2, start: 0, end: 2 }, { type: 'col', index: 3, start: 2, end: 6 }, { type: 'col', index: 4, start: 0, end: 2 }, { type: 'col', index: 5, start: 3, end: 5 }] },
            'monster': { id: 'monster', name: 'Monster Monster', themeId: 'monster_mash', timeLimit: 180, isTwinningCell: (r, c) => (r === 0 && c <= 2) || (r === 2 && c <= 4) || (r === 3 && c >= 4) || (r === 4 && c >= 2 && c <= 4) || (r === 6 && c <= 3) || (c === 0 && r <= 2) || (c === 2 && r <= 4) || (c === 3 && r >= 4) || (c === 4 && r >= 2 && r <= 4), getCrossScoreSegments: () => [ { type: 'row', index: 0, start: 0, end: 2 }, { type: 'row', index: 2, start: 0, end: 4 }, { type: 'row', index: 3, start: 4, end: 6 }, { type: 'row', index: 4, start: 2, end: 4 }, { type: 'row', index: 6, start: 0, end: 3 }, { type: 'col', index: 0, start: 0, end: 2 }, { type: 'col', index: 2, start: 0, end: 4 }, { type: 'col', index: 3, start: 4, end: 6 }, { type: 'col', index: 4, start: 2, end: 4 }] }
        };

        class GameState {
            // ... (GameState class remains unchanged)
        }

        class Game {
            // ... (Game class constructor remains unchanged)

            // ... (getDOMElements, init, getState, audio methods remain unchanged)

            // ... (timer methods remain unchanged)
            
            // ... (scoring logic: calculateLineScore, isValidSequence remain unchanged)

            isLineDead(line) {
                for (let i = 0; i <= line.length - this.MIN_SEQUENCE_LENGTH; i++) {
                    const window = line.slice(i, i + this.MIN_SEQUENCE_LENGTH);
                    if (window.includes(this.SPECIAL_SYMBOLS.WILD)) continue; // A wildcard keeps a window "alive"
                    if (window.includes(this.SPECIAL_SYMBOLS.CURSED)) continue;
                    const regularSymbols = window.filter(s => s && s !== this.SPECIAL_SYMBOLS.WILD);
                    if (new Set(regularSymbols).size <= 1) return false;
                }
                return true;
            }

            // ... (calculateBonusGrids remains unchanged)

            // ... (cell creation/update, UI update methods remain unchanged)

            // ... (handleCellClick and other event handlers remain unchanged)

            calculateCrossScore() {
                let bonusScore = 0;
                const getScoreForSegment = (segmentSymbols) => {
                    if (segmentSymbols.length < this.MIN_SEQUENCE_LENGTH) {
                        return 0;
                    }
                    let score = 0; const usedIndices = new Set();
                    for (let len = segmentSymbols.length; len >= this.MIN_SEQUENCE_LENGTH; len--) {
                         for (let i = 0; i <= segmentSymbols.length - len; i++) {
                            if ([...Array(len).keys()].some(k => usedIndices.has(i + k))) continue;
                            const slice = segmentSymbols.slice(i, i + len);
                            if (this.isValidSequence(slice)) {
                                score += this.SCORING_RULES[len] || 0;
                                for (let k = 0; k < len; k++) if (slice[k] !== this.SPECIAL_SYMBOLS.WILD) usedIndices.add(i + k);
                            }
                        }
                    }
                    if (score > 0) return score;
                    if (this.isLineDead(segmentSymbols)) return this.CROSS_DEATH_PENALTY;
                    return 0;
                };

                this.config.getCrossScoreSegments().forEach(seg => {
                    const segmentSymbols = [];
                    if (seg.type === 'diag_main') { // Main diagonal
                        for (let i = 0; i < this.GRID_SIZE; i++) segmentSymbols.push(this.gridData[i][i]);
                    } else if (seg.type === 'diag_anti') { // Anti-diagonal
                        for (let i = 0; i < this.GRID_SIZE; i++) segmentSymbols.push(this.gridData[i][this.GRID_SIZE - 1 - i]);
                    } else { // Row or Col
                        for (let i = seg.start; i <= seg.end; i++) {
                            segmentSymbols.push(seg.type === 'row' ? this.gridData[seg.index][i] : this.gridData[i][seg.index]);
                        }
                    }
                    bonusScore += getScoreForSegment(segmentSymbols);
                });
                return bonusScore;
            }
            
            // ... (rest of Game class remains unchanged)
        }
        
        // --- GAME MANAGER ---
        const gameManager = {
            // ... (gameManager object remains unchanged except for the two timer fixes)
            switchVariant(variantId, isTimeBurst, isNewGame = false) {
                if (this.currentGameInstance) {
                    this.currentGameInstance.stopTimer();
                }
                // ... rest of function is unchanged
            },
            
            resetCurrentVariant() {
                if (this.currentGameInstance) {
                    this.currentGameInstance.stopTimer();
                }
                this.switchVariant(this.activeVariantId, this.currentGameInstance.isTimeBurst, true);
            },
            // ...
        };

        document.addEventListener('DOMContentLoaded', () => {
            // ... (this remains unchanged)
        });
    </script>
</body>
</html>
